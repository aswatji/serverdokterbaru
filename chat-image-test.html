<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Test - Image Upload</title>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f0f2f5;
    }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: #0084ff;
      color: white;
      padding: 15px 20px;
      font-weight: bold;
    }
    .status {
      padding: 10px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e5e5;
      font-size: 14px;
    }
    .status.connected { color: #28a745; }
    .status.disconnected { color: #dc3545; }
    .controls {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e5e5;
    }
    .controls input, .controls button, .controls select {
      padding: 10px 15px;
      margin: 5px 5px 5px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    .controls button {
      background: #0084ff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    .controls button:hover { background: #0073e6; }
    .controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .file-input-label {
      display: inline-block;
      padding: 10px 15px;
      background: #28a745;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px 5px 5px 0;
    }
    .file-input-label:hover { background: #218838; }
    #imageInput { display: none; }
    .messages {
      height: 400px;
      overflow-y: auto;
      padding: 20px;
    }
    .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 8px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .message.user {
      background: #0084ff;
      color: white;
      margin-left: auto;
      text-align: right;
    }
    .message.doctor {
      background: #e4e6eb;
      color: #050505;
    }
    .message img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 5px;
    }
    .message .time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 5px;
      display: block;
    }
    .message .status-indicator {
      font-size: 10px;
      margin-top: 3px;
    }
    .input-area {
      padding: 15px 20px;
      background: white;
      border-top: 1px solid #e5e5e5;
      display: flex;
      gap: 10px;
    }
    .input-area input[type="text"] {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
    }
    .input-area button {
      padding: 10px 20px;
      background: #0084ff;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
    }
    .input-area button:hover { background: #0073e6; }
    .input-area button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .sending { opacity: 0.6; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      üí¨ Chat Test Client - Socket.IO with Image Upload
    </div>

    <div class="status" id="status">
      üî¥ Disconnected
    </div>

    <div class="controls">
      <input type="text" id="chatId" placeholder="Chat ID" value="chat123" />
      <select id="senderType">
        <option value="user">User</option>
        <option value="doctor">Doctor</option>
      </select>
      <button onclick="joinChat()">üì° Join Chat</button>
      <label for="imageInput" class="file-input-label">üì∑ Upload Image</label>
      <input type="file" id="imageInput" accept="image/*" onchange="sendImage()" />
    </div>

    <div class="messages" id="messages"></div>

    <div class="input-area">
      <input
        type="text"
        id="messageInput"
        placeholder="Type a message..."
        onkeypress="handleKeyPress(event)"
      />
      <button onclick="sendText()" id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    const socket = io("http://localhost:3000", {
      transports: ["websocket", "polling"],
      reconnection: true,
    });

    let currentChatId = null;
    let isSending = false;

    // Connection status
    socket.on("connect", () => {
      console.log("‚úÖ Connected:", socket.id);
      document.getElementById("status").innerHTML = "üü¢ Connected: " + socket.id;
      document.getElementById("status").className = "status connected";
    });

    socket.on("disconnect", () => {
      console.log("üî¥ Disconnected");
      document.getElementById("status").innerHTML = "üî¥ Disconnected";
      document.getElementById("status").className = "status disconnected";
    });

    // New message received
    socket.on("new_message", (data) => {
      console.log("üì© New message:", data);
      displayMessage(data);
    });

    // Error handling
    socket.on("error", (error) => {
      console.error("‚ùå Socket error:", error);
      alert("Error: " + error.message);
      isSending = false;
      updateSendButton();
    });

    // Join chat room
    function joinChat() {
      currentChatId = document.getElementById("chatId").value.trim();
      if (!currentChatId) {
        alert("Please enter Chat ID");
        return;
      }
      
      socket.emit("join_chat", currentChatId);
      console.log("üëã Joined chat:", currentChatId);
      
      // Clear messages
      document.getElementById("messages").innerHTML = `<p style="text-align:center; color:#999;">Joined chat: ${currentChatId}</p>`;
    }

    // Send text message with callback
    function sendText() {
      const content = document.getElementById("messageInput").value.trim();
      if (!content || !currentChatId) {
        alert("Please join a chat and type a message");
        return;
      }

      if (isSending) return;
      isSending = true;
      updateSendButton();

      const sender = document.getElementById("senderType").value;
      const payload = {
        chatId: currentChatId,
        sender: sender,
        content: content,
        type: "text"
      };

      // Add temporary "sending" message
      const tempId = "temp-" + Date.now();
      displayMessage({
        messageId: tempId,
        chatId: currentChatId,
        sender: sender,
        content: content,
        type: "text",
        sentAt: new Date().toISOString(),
        sending: true
      });

      // Emit with callback
      socket.emit("send_message", payload, (response) => {
        isSending = false;
        updateSendButton();

        if (response.success) {
          console.log("‚úÖ Message sent:", response.data);
          document.getElementById("messageInput").value = "";
          
          // Remove temp message
          const tempEl = document.querySelector(`[data-msg-id="${tempId}"]`);
          if (tempEl) tempEl.remove();
        } else {
          console.error("‚ùå Failed:", response.error);
          alert("Failed to send: " + response.error);
          
          // Mark as failed
          const tempEl = document.querySelector(`[data-msg-id="${tempId}"]`);
          if (tempEl) {
            tempEl.style.background = "#ffcccc";
            tempEl.innerHTML += '<div class="status-indicator">‚ùå Failed</div>';
          }
        }
      });
    }

    // Send image with callback
    function sendImage() {
      const file = document.getElementById("imageInput").files[0];
      if (!file || !currentChatId) {
        alert("Please join a chat first");
        return;
      }

      if (isSending) {
        alert("Please wait, still sending...");
        return;
      }

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert("File size too large. Max 5MB");
        return;
      }

      isSending = true;
      updateSendButton();

      const sender = document.getElementById("senderType").value;
      const reader = new FileReader();

      reader.onload = function(e) {
        const base64Data = e.target.result; // "data:image/png;base64,..."
        
        const payload = {
          chatId: currentChatId,
          sender: sender,
          type: "image",
          fileData: base64Data,
          content: "" // Optional caption
        };

        console.log("üì§ Uploading image...");

        // Emit with callback
        socket.emit("send_message", payload, (response) => {
          isSending = false;
          updateSendButton();
          document.getElementById("imageInput").value = ""; // Clear input

          if (response.success) {
            console.log("‚úÖ Image sent:", response.data);
            // Message will be displayed via new_message event
          } else {
            console.error("‚ùå Failed:", response.error);
            alert("Failed to send image: " + response.error);
          }
        });
      };

      reader.onerror = function() {
        alert("Failed to read file");
        isSending = false;
        updateSendButton();
      };

      reader.readAsDataURL(file);
    }

    // Display message in UI
    function displayMessage(data) {
      const msgDiv = document.getElementById("messages");
      const msgEl = document.createElement("div");
      msgEl.className = `message ${data.sender}`;
      msgEl.setAttribute("data-msg-id", data.messageId);
      
      if (data.sending) {
        msgEl.classList.add("sending");
      }

      let content = "";
      if (data.type === "text") {
        content = data.content;
      } else if (data.type === "image") {
        content = `<img src="${data.content}" alt="sent image" loading="lazy" />`;
      } else if (data.type === "pdf" || data.type === "file") {
        content = `<a href="${data.content}" target="_blank">üìÑ ${data.type.toUpperCase()} File</a>`;
      }

      const time = new Date(data.sentAt).toLocaleTimeString();
      msgEl.innerHTML = `
        ${content}
        <span class="time">${time}</span>
        ${data.sending ? '<div class="status-indicator">‚è≥ Sending...</div>' : ''}
      `;

      msgDiv.appendChild(msgEl);
      msgDiv.scrollTop = msgDiv.scrollHeight;
    }

    // Update send button state
    function updateSendButton() {
      const btn = document.getElementById("sendBtn");
      btn.disabled = isSending;
      btn.textContent = isSending ? "Sending..." : "Send";
    }

    // Handle Enter key
    function handleKeyPress(event) {
      if (event.key === "Enter" && !isSending) {
        sendText();
      }
    }

    console.log("üöÄ Chat client ready. Connect to: http://localhost:3000");
  </script>
</body>
</html>
