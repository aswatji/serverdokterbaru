// ======================================================
// ‚úÖ FIXED FINAL SCHEMA PRISMA (VALIDATED - NO ERRORS)
// ======================================================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ======================================================
// 1Ô∏è‚É£ USER MODEL
// ======================================================
model User {
  id           String     @id @default(cuid())
  email        String     @unique
  password     String
  fullname     String
  photo        String?
  profession   String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  chats        Chat[]     @relation("UserChats")
  payments     Payment[]
}

// ======================================================
// 2Ô∏è‚É£ DOCTOR MODEL
// ======================================================
model Doctor {
  id               String      @id @default(cuid())
  fullname         String
  category         String
  university       String
  strNumber        String      @unique
  gender           String
  email            String      @unique
  password         String
  bio              String?
  photo            String?
  alamatRumahSakit String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  chats            Chat[]      @relation("DoctorChats")
  schedules        DoctorSchedule[]
  payments         Payment[]
}

// ======================================================
// 3Ô∏è‚É£ DOCTOR SCHEDULE MODEL
// ======================================================
model DoctorSchedule {
  id        String   @id @default(cuid())
  doctor    Doctor   @relation(fields: [doctorId], references: [id])
  doctorId  String
  dayOfWeek Int
  startTime DateTime
  endTime   DateTime
}

// ======================================================
// 4Ô∏è‚É£ PAYMENT MODEL - Wajib sukses sebelum chat aktif
// ======================================================
model Payment {
  id           String   @id @default(cuid())
  amount       Float
  status       String   // "pending" | "success" | "failed"
  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id])
  userId       String
  doctor       Doctor   @relation(fields: [doctorId], references: [id])
  doctorId     String

  // ‚úÖ Hanya sisi ini yang tanpa fields/references (otomatis inverse)
  chat         Chat?
}

// ======================================================
// 5Ô∏è‚É£ CHAT MODEL - Ruang chat utama
// ======================================================
model Chat {
  id             String        @id @default(cuid())
  chatKey        String        @unique
  userId         String
  doctorId       String
  paymentId      String?       @unique
  lastMessageId  String?       @unique
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now()) @updatedAt

  user           User          @relation("UserChats", fields: [userId], references: [id])
  doctor         Doctor        @relation("DoctorChats", fields: [doctorId], references: [id])
  payment        Payment?      @relation(fields: [paymentId], references: [id]) // ‚úÖ hanya Chat yang pegang fields/references
  lastMessage    ChatMessage?  @relation("LastMessageRelation", fields: [lastMessageId], references: [id])
  dates          ChatDate[]
  @@unique([userId, doctorId]) // üî• ini kunci utamanya
}

// ======================================================
// 6Ô∏è‚É£ CHAT DATE MODEL - Group chat per tanggal
// ======================================================
model ChatDate {
  id        String         @id @default(cuid())
  chatId    String
  date      DateTime
  createdAt DateTime       @default(now())

  chat      Chat           @relation(fields: [chatId], references: [id])
  messages  ChatMessage[]
}

// ======================================================
// 7Ô∏è‚É£ CHAT MESSAGE MODEL - Semua pesan di hari tertentu
// ======================================================
model ChatMessage {
  id          String     @id @default(cuid())
  chatDateId  String
  sender      String
  content     String
  sentAt      DateTime   @default(now())

  chatDate    ChatDate   @relation(fields: [chatDateId], references: [id])
  chatLastMessage Chat?  @relation("LastMessageRelation")
}

// ======================================================
// 8Ô∏è‚É£ NEWS MODEL
// ======================================================
model News {
  id        String   @id @default(cuid())
  title     String
  content   String
  image     String?
  createdAt DateTime @default(now())
}

// ======================================================
// 9Ô∏è‚É£ CATEGORY MODEL
// ======================================================
model Category {
  id     String  @id @default(cuid())
  name   String
  items  String?
}

// ======================================================
// üîü CATEGORY DOCTOR MODEL
// ======================================================
model CategoryDoctor {
  id        Int      @id @default(autoincrement())
  category  String
}
